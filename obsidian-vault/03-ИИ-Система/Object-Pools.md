# Object Pools - Система Пулов Объектов

## Обзор

Система пулов объектов (Object Pools) предназначена для оптимизации производительности путем переиспользования объектов вместо их постоянного создания и уничтожения. Это особенно важно для игровых систем, где создается множество временных объектов.

## Архитектура

### Основные компоненты

#### 1. ObjectPool<T>
Базовый класс для управления пулом объектов определенного типа.

**Ключевые особенности:**
- Thread-safe операции
- Ограничение максимального размера пула
- Статистика использования
- Автоматическое управление жизненным циклом объектов

**Основные методы:**
```java
T acquire()                    // Получение объекта из пула
boolean release(T object)      // Возврат объекта в пул
int prefill(int count)         // Предварительное заполнение
void clear()                   // Очистка пула
String getStatistics()         // Получение статистики
```

#### 2. PoolManager
Центральный менеджер для управления всеми пулами в системе.

**Функциональность:**
- Регистрация пулов для различных типов
- Автоматическая инициализация пулов по умолчанию
- Мониторинг и статистика
- Управление жизненным циклом пулов

**Предустановленные пулы:**
- `MoveAction` - действия движения
- `AttackAction` - действия атаки
- `CastAction` - действия применения умений
- `LootAction` - действия сбора лута
- `BotContext` - контексты ботов

#### 3. PoolableObject
Интерфейс для объектов, которые могут быть переиспользованы в пуле.

**Методы:**
```java
void markInUse()      // Пометить как используемый
void markFree()       // Пометить как свободный
boolean isInUse()     // Проверить статус использования
```

## Преимущества

### 1. Производительность
- **Снижение нагрузки на GC** - меньше объектов для сборки мусора
- **Быстрое получение объектов** - O(1) время получения из пула
- **Предсказуемое потребление памяти** - фиксированный размер пула

### 2. Стабильность
- **Избежание OutOfMemoryError** - контроль максимального размера
- **Стабильная производительность** - нет пиков при создании объектов
- **Thread-safety** - безопасная работа в многопоточной среде

### 3. Мониторинг
- **Детальная статистика** - отслеживание использования
- **Метрики производительности** - коэффициент переиспользования
- **Диагностика проблем** - выявление узких мест

## Использование

### Базовое использование

```java
// Создание пула
ObjectPool<MyObject> pool = new ObjectPool<>(
    () -> new MyObject(),  // Фабрика объектов
    100                    // Максимальный размер
);

// Получение объекта
MyObject obj = pool.acquire();

// Использование объекта
obj.doSomething();

// Возврат в пул
pool.release(obj);
```

### Использование через PoolManager

```java
// Получение менеджера
PoolManager manager = PoolManager.getInstance();

// Получение объекта из предустановленного пула
BotContext context = manager.acquire(BotContext.class);

// Использование
context.setState(BotState.ACTIVE);

// Возврат в пул
manager.release(context);
```

### Операции с объектами

```java
// Выполнение операции с автоматическим возвратом
String result = manager.withPooledObject(MyObject.class, obj -> {
    return obj.processData();
});
```

## Статистика и мониторинг

### Метрики пула

- **Available Count** - количество доступных объектов
- **Created Count** - общее количество созданных объектов
- **Reuse Ratio** - коэффициент переиспользования
- **Request Count** - количество запросов
- **Return Count** - количество возвратов

### Получение статистики

```java
// Статистика конкретного пула
String stats = pool.getStatistics();

// Общая статистика всех пулов
String allStats = manager.getAllStatistics();

// Программный доступ к метрикам
int available = pool.getAvailableCount();
int created = pool.getCreatedCount();
double reuseRatio = pool.getReuseRatio();
```

## Конфигурация

### Размеры пулов по умолчанию

- **ACTION_POOL_SIZE** = 200 - для действий ботов
- **CONTEXT_POOL_SIZE** = 50 - для контекстов ботов
- **DEFAULT_POOL_SIZE** = 100 - для пользовательских пулов

### Настройка пулов

```java
// Регистрация пула с кастомным размером
manager.registerPool(MyClass.class, () -> new MyClass(), 500);

// Предварительное заполнение
manager.prefillPool(MyClass.class, 100);

// Очистка пула
manager.clearPool(MyClass.class);
```

## Лучшие практики

### 1. Выбор размера пула
- **Не слишком маленький** - избежать блокировок
- **Не слишком большой** - не тратить память впустую
- **Анализ статистики** - настройка на основе реального использования

### 2. Управление жизненным циклом
- **Всегда возвращать объекты** - использовать try-finally
- **Очистка состояния** - сброс данных перед возвратом
- **Проверка статуса** - убедиться, что объект свободен

### 3. Мониторинг
- **Регулярная проверка статистики** - выявление проблем
- **Анализ коэффициента переиспользования** - оптимизация размера
- **Логирование аномалий** - отслеживание необычных паттернов

## Интеграция с системой ботов

### Автоматическое управление

Система пулов интегрирована с основными компонентами ботов:

- **ActionManager** - использует пулы для действий
- **BotContext** - контексты ботов управляются через пулы
- **Behavior System** - поведения могут использовать пулы для временных объектов

### Оптимизация производительности

- **Снижение задержек** - быстрый доступ к объектам
- **Стабильная производительность** - отсутствие пиков GC
- **Масштабируемость** - эффективная работа с множественными ботами

## Тестирование

### Покрытие тестами

- **17 тестов ObjectPool** - полное покрытие функциональности
- **23 теста PoolManager** - тестирование менеджера
- **Многопоточные тесты** - проверка thread-safety
- **Тесты производительности** - измерение эффективности

### Типы тестов

- **Unit тесты** - тестирование отдельных компонентов
- **Integration тесты** - тестирование взаимодействия
- **Performance тесты** - измерение производительности
- **Concurrency тесты** - тестирование многопоточности

## Заключение

Система пулов объектов является критически важным компонентом для обеспечения высокой производительности системы ботов. Она обеспечивает:

- **Эффективное управление памятью**
- **Стабильную производительность**
- **Масштабируемость системы**
- **Детальный мониторинг**

Правильное использование пулов объектов позволяет системе ботов работать с сотнями активных ботов без деградации производительности.
