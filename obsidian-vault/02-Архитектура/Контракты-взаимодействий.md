# 🤝 Контракты взаимодействий системы ботов

## 📋 Обзор

Этот документ содержит sequence диаграммы, визуализирующие контракты взаимодействия между различными компонентами системы ботов L2J.

## 🏗️ Создание бота

### Основной процесс создания бота

```mermaid
sequenceDiagram
    participant Client as Клиент
    participant BotManager as BotManager
    participant BotFactory as BotFactory
    participant BotContext as BotContext
    participant EnhancedFakePlayer as EnhancedFakePlayer
    participant EventManager as EventManager
    participant AIManager as AIManager

    Client->>BotManager: createBot(botType)
    BotManager->>BotFactory: createBot(botType)
    
    BotFactory->>BotContext: new BotContext(botId)
    BotContext-->>BotFactory: context
    
    BotFactory->>BotFactory: createBotContext(botId, botType)
    BotFactory->>BotContext: setData("botType", botType)
    BotFactory->>BotContext: setData("level", 1)
    BotFactory->>BotContext: setData("maxHp", 100)
    
    BotFactory->>EnhancedFakePlayer: new EnhancedFakePlayer(context, botType)
    EnhancedFakePlayer-->>BotFactory: bot
    
    BotFactory->>AIManager: configureAISystem(bot, context)
    AIManager->>BotContext: setData("aiComponents", components)
    
    BotFactory->>BotFactory: configureBotTypeSpecific(botType, context)
    BotFactory->>BotContext: setData("targetLevel", 20)
    BotFactory->>BotContext: setData("targetKills", 100)
    
    BotFactory->>EnhancedFakePlayer: start()
    EnhancedFakePlayer->>EnhancedFakePlayer: active.set(true)
    EnhancedFakePlayer->>BotContext: setState(BotState.IDLE)
    
    BotFactory->>EventManager: publish(BotCreatedEvent)
    EventManager->>EventManager: processEvent(event)
    
    BotFactory-->>BotManager: bot
    BotManager->>BotManager: addBot(bot)
    BotManager-->>Client: bot
```

### Обработка ошибок при создании бота

```mermaid
sequenceDiagram
    participant Client as Клиент
    participant BotManager as BotManager
    participant BotFactory as BotFactory
    participant BotContext as BotContext
    participant EventManager as EventManager

    Client->>BotManager: createBot(botType)
    BotManager->>BotFactory: createBot(botType)
    
    BotFactory->>BotContext: new BotContext(botId)
    BotContext-->>BotFactory: context
    
    BotFactory->>BotContext: setData("botType", botType)
    Note over BotContext: NullPointerException
    
    BotContext->>BotContext: synchronized initialization
    BotContext-->>BotFactory: success
    
    BotFactory->>EventManager: publish(BotCreatedEvent)
    EventManager->>EventManager: processEvent(event)
    
    BotFactory-->>BotManager: bot
    BotManager-->>Client: bot
```

## 🎯 AI система принятия решений

### Процесс принятия решения ботом

```mermaid
sequenceDiagram
    participant Bot as EnhancedFakePlayer
    participant AIManager as AIManager
    participant GoalPlanner as GoalPlanner
    participant ActionPlanner as ActionPlanner
    participant BehaviorSelector as BehaviorSelector
    participant BehaviorManager as BehaviorManager
    participant ActionManager as ActionManager

    Bot->>AIManager: makeDecision()
    
    AIManager->>GoalPlanner: createGoalPlan(bot)
    GoalPlanner->>GoalPlanner: analyzeCurrentState()
    GoalPlanner->>GoalPlanner: prioritizeGoals()
    GoalPlanner-->>AIManager: goals
    
    AIManager->>BehaviorSelector: selectBehavior(bot, availableBehaviors)
    BehaviorSelector->>BehaviorManager: getAllBehaviors()
    BehaviorManager-->>BehaviorSelector: behaviors
    BehaviorSelector->>BehaviorSelector: evaluateStrategies()
    BehaviorSelector-->>AIManager: selectedBehavior
    
    AIManager->>ActionPlanner: createActionPlan(bot, goal)
    ActionPlanner->>ActionPlanner: planActions(goal)
    ActionPlanner-->>AIManager: actionPlan
    
    AIManager->>ActionManager: executeAction(action)
    ActionManager->>ActionManager: validateAction(action)
    ActionManager->>Bot: performAction(action)
    Bot->>Bot: executeAction(action)
    
    ActionManager-->>AIManager: result
    AIManager-->>Bot: decisionResult
```

### Переключение поведения бота

```mermaid
sequenceDiagram
    participant Bot as EnhancedFakePlayer
    participant BehaviorSelector as BehaviorSelector
    participant CurrentBehavior as Текущее поведение
    participant NewBehavior as Новое поведение
    participant EventManager as EventManager

    Bot->>BehaviorSelector: switchBehavior()
    
    BehaviorSelector->>CurrentBehavior: onEnd(botContext)
    CurrentBehavior->>CurrentBehavior: cleanup()
    CurrentBehavior-->>BehaviorSelector: completed
    
    BehaviorSelector->>BehaviorSelector: selectNewBehavior()
    BehaviorSelector-->>Bot: newBehavior
    
    Bot->>NewBehavior: onStart(botContext)
    NewBehavior->>NewBehavior: initialize()
    NewBehavior-->>Bot: ready
    
    Bot->>EventManager: publish(BehaviorChangedEvent)
    EventManager->>EventManager: processEvent(event)
    
    Bot->>Bot: updateBehavior(newBehavior)
```

## 📡 Система событий

### Публикация и обработка событий

```mermaid
sequenceDiagram
    participant Publisher as Издатель
    participant EventManager as EventManager
    participant Listener1 as Слушатель 1
    participant Listener2 as Слушатель 2
    participant ExecutorService as ExecutorService

    Publisher->>EventManager: publish(event)
    EventManager->>EventManager: validateEvent(event)
    
    EventManager->>ExecutorService: submit(eventProcessor)
    ExecutorService->>EventManager: processEvent(event)
    
    EventManager->>Listener1: onEvent(event)
    Listener1->>Listener1: handleEvent(event)
    Listener1-->>EventManager: processed
    
    EventManager->>Listener2: onEvent(event)
    Listener2->>Listener2: handleEvent(event)
    Listener2-->>EventManager: processed
    
    EventManager->>EventManager: updateMetrics()
    EventManager-->>Publisher: eventProcessed
```

### Подписка на события

```mermaid
sequenceDiagram
    participant Listener as Слушатель
    participant EventManager as EventManager
    participant EventType as EventType
    participant SubscriptionMap as SubscriptionMap

    Listener->>EventManager: subscribe(eventType, listener)
    EventManager->>EventType: validateEventType(eventType)
    EventType-->>EventManager: valid
    
    EventManager->>SubscriptionMap: addSubscription(eventType, listener)
    SubscriptionMap->>SubscriptionMap: storeSubscription()
    SubscriptionMap-->>EventManager: stored
    
    EventManager->>EventManager: updateListenerCount()
    EventManager-->>Listener: subscribed
```

## 🔄 Жизненный цикл бота

### Полный жизненный цикл бота

```mermaid
sequenceDiagram
    participant BotManager as BotManager
    participant BotFactory as BotFactory
    participant Bot as EnhancedFakePlayer
    participant EventManager as EventManager
    participant AIManager as AIManager
    participant ActionManager as ActionManager

    BotManager->>BotFactory: createBot(botType)
    BotFactory->>Bot: new EnhancedFakePlayer()
    Bot-->>BotFactory: bot
    BotFactory->>Bot: start()
    Bot->>Bot: active.set(true)
    Bot->>EventManager: publish(BotCreatedEvent)
    
    loop Основной цикл работы
        Bot->>AIManager: makeDecision()
        AIManager->>ActionManager: executeAction()
        ActionManager->>Bot: performAction()
        Bot->>Bot: updateState()
    end
    
    BotManager->>Bot: stop()
    Bot->>Bot: active.set(false)
    Bot->>EventManager: publish(BotStoppedEvent)
    
    BotManager->>BotManager: removeBot(botId)
    BotManager->>EventManager: publish(BotRemovedEvent)
```

## 🎮 Игровые действия

### Выполнение игрового действия

```mermaid
sequenceDiagram
    participant Bot as EnhancedFakePlayer
    participant ActionManager as ActionManager
    participant MoveAction as MoveAction
    participant AttackAction as AttackAction
    participant LootAction as LootAction
    participant GameServer as L2J GameServer

    Bot->>ActionManager: executeAction(actionType)
    ActionManager->>ActionManager: validateAction(actionType)
    
    alt Движение
        ActionManager->>MoveAction: execute(bot)
        MoveAction->>Bot: getCurrentPosition()
        Bot-->>MoveAction: position
        MoveAction->>GameServer: moveTo(targetPosition)
        GameServer-->>MoveAction: success
        MoveAction-->>ActionManager: completed
    else Атака
        ActionManager->>AttackAction: execute(bot)
        AttackAction->>Bot: getTarget()
        Bot-->>AttackAction: target
        AttackAction->>GameServer: attack(target)
        GameServer-->>AttackAction: success
        AttackAction-->>ActionManager: completed
    else Лут
        ActionManager->>LootAction: execute(bot)
        LootAction->>Bot: getLootableItems()
        Bot-->>LootAction: items
        LootAction->>GameServer: loot(items)
        GameServer-->>LootAction: success
        LootAction-->>ActionManager: completed
    end
    
    ActionManager->>Bot: updateState()
    ActionManager-->>Bot: actionCompleted
```

## 📊 Мониторинг и метрики

### Сбор метрик системы

```mermaid
sequenceDiagram
    participant MetricsCollector as MetricsCollector
    participant BotManager as BotManager
    participant EventManager as EventManager
    participant AIManager as AIManager
    participant CacheManager as CacheManager
    participant MemoryMXBean as MemoryMXBean
    participant ThreadMXBean as ThreadMXBean

    MetricsCollector->>BotManager: getActiveBotCount()
    BotManager-->>MetricsCollector: activeCount
    
    MetricsCollector->>BotManager: getTotalBotsCreated()
    BotManager-->>MetricsCollector: totalCreated
    
    MetricsCollector->>EventManager: getTotalEventsProcessed()
    EventManager-->>MetricsCollector: totalEvents
    
    MetricsCollector->>CacheManager: size()
    CacheManager-->>MetricsCollector: cacheSize
    
    MetricsCollector->>MemoryMXBean: getHeapMemoryUsage()
    MemoryMXBean-->>MetricsCollector: memoryUsage
    
    MetricsCollector->>ThreadMXBean: getThreadCount()
    ThreadMXBean-->>MetricsCollector: threadCount
    
    MetricsCollector->>MetricsCollector: logMetrics()
    MetricsCollector->>MetricsCollector: updateDashboard()
```

## 🔧 Обработка ошибок

### Обработка исключений в системе

```mermaid
sequenceDiagram
    participant Component as Компонент
    participant ErrorHandler as ErrorHandler
    participant Logger as Logger
    participant EventManager as EventManager
    participant BotManager as BotManager

    Component->>Component: performOperation()
    Note over Component: Exception occurs
    
    Component->>ErrorHandler: handleException(exception)
    ErrorHandler->>Logger: logError(exception)
    Logger->>Logger: writeToLog()
    
    ErrorHandler->>EventManager: publish(ErrorEvent)
    EventManager->>EventManager: processEvent()
    
    alt Критическая ошибка
        ErrorHandler->>BotManager: stopAllBots()
        BotManager->>BotManager: emergencyShutdown()
    else Восстановимая ошибка
        ErrorHandler->>Component: retryOperation()
        Component->>Component: retry()
    end
    
    ErrorHandler-->>Component: handled
```

## 🎯 Специализированные контракты

### Контракт Farmer бота

```mermaid
sequenceDiagram
    participant FarmerBot as Farmer Bot
    participant GoalPlanner as GoalPlanner
    participant ActionPlanner as ActionPlanner
    participant MoveAction as MoveAction
    participant AttackAction as AttackAction
    participant LootAction as LootAction

    FarmerBot->>GoalPlanner: createGoalPlan()
    GoalPlanner->>GoalPlanner: prioritizeGoals()
    Note over GoalPlanner: 1. FarmAdena (80)<br/>2. Survive (100)<br/>3. CompleteQuests (70)
    
    GoalPlanner-->>FarmerBot: goals
    
    FarmerBot->>ActionPlanner: createActionPlan(goal)
    ActionPlanner->>ActionPlanner: planFarmingActions()
    Note over ActionPlanner: 1. Search (70)<br/>2. MoveToTarget (60)<br/>3. Attack (50)<br/>4. Loot (40)
    
    ActionPlanner-->>FarmerBot: actionPlan
    
    FarmerBot->>MoveAction: execute()
    MoveAction-->>FarmerBot: completed
    
    FarmerBot->>AttackAction: execute()
    AttackAction-->>FarmerBot: completed
    
    FarmerBot->>LootAction: execute()
    LootAction-->>FarmerBot: completed
```

### Контракт Quester бота

```mermaid
sequenceDiagram
    participant QuesterBot as Quester Bot
    participant GoalPlanner as GoalPlanner
    participant ActionPlanner as ActionPlanner
    participant SearchAction as SearchAction
    participant TalkToNPCAction as TalkToNPCAction
    participant InteractAction as InteractAction

    QuesterBot->>GoalPlanner: createGoalPlan()
    GoalPlanner->>GoalPlanner: prioritizeGoals()
    Note over GoalPlanner: 1. CompleteQuests (70)<br/>2. Survive (100)<br/>3. FarmAdena (80)
    
    GoalPlanner-->>QuesterBot: goals
    
    QuesterBot->>ActionPlanner: createActionPlan(goal)
    ActionPlanner->>ActionPlanner: planQuestingActions()
    Note over ActionPlanner: 1. Search (70)<br/>2. MoveToTarget (60)<br/>3. TalkToNPC (50)<br/>4. Interact (45)
    
    ActionPlanner-->>QuesterBot: actionPlan
    
    QuesterBot->>SearchAction: execute()
    SearchAction-->>QuesterBot: completed
    
    QuesterBot->>TalkToNPCAction: execute()
    TalkToNPCAction-->>QuesterBot: completed
    
    QuesterBot->>InteractAction: execute()
    InteractAction-->>QuesterBot: completed
```

## 📝 Примечания

### Условные обозначения:
- **Сплошная стрелка** → Синхронный вызов
- **Пунктирная стрелка** - - - Асинхронный вызов
- **Note** 📝 Дополнительная информация
- **Alt** 🔀 Условная логика
- **Loop** 🔄 Циклические операции

### Ключевые принципы:
1. **Изоляция ошибок** - каждый компонент обрабатывает свои ошибки
2. **Асинхронность** - события обрабатываются асинхронно
3. **Валидация** - все входные данные проверяются
4. **Логирование** - все операции логируются
5. **Метрики** - производительность отслеживается

### Расширение контрактов:
- Новые типы ботов добавляют свои специфичные диаграммы
- Новые действия расширяют существующие контракты
- Система событий позволяет добавлять новые типы событий

